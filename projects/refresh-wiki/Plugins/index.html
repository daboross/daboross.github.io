<!DOCTYPE html>
<html><head><title>refresh-wiki - Plugins</title><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=icon type=image/png href=/favicon.png><link href=/assets/documentation.css?b0fcf9b2 rel=stylesheet></head><body><div class=container><div class=row><div class="col-md-8 col-md-offset-1 col-xs-12 col-xs-offset-0"><div class=list-group><div class=list-group-item><h1>Writing Plugins for CloudBot Refresh</h1><p>Writing plugins for CloudBot is simple! This guide seeks to explain everything you need to do to.</p><p>If you have any trouble understanding the guide, come chat with us in the #cloudbot IRC channel on irc.esper.net.</p><h2>Plugin structure</h2><p>Every plugin written for CloudBot is essentially a python file located in the <strong>plugins</strong> directory. The plugin must be written in python 3, and the file name must end in <strong>.py</strong> to be detected by CloudBot.</p><p>Each plugin file may contain any number of hooks, to create commands, listen to events, watch input for certain patterns, or control other plugins.</p><h2>Detailed first-command guide</h2><p>If this is your first time writing plugins for CloudBot, check out the <a href=https://github.com/CloudBotIRC/CloudBot/wiki/Writing-your-first-command-plugin>Writing your first command plugin</a> guide.</p><h2>Hook types</h2><p>Here are a few example hook types. We&#39;ll go into more detail later, but this lists all the ones you can use</p><h3>Command Hook</h3><p>The command hook can be used to register a command in CloudBot.</p><p>Here&#39;s an example command which will return the input given to it, added to itself.</p><div class=highlight><pre><span></span><span class=kn>from</span> <span class=nn>cloudbot</span> <span class=kn>import</span> <span class=n>hook</span>


<span class=nd>@hook.command</span><span class=p>()</span>
<span class=k>def</span> <span class=nf>echo</span><span class=p>(</span><span class=n>text</span><span class=p>):</span>
    <span class=k>return</span> <span class=n>text</span> <span class=o>+</span> <span class=s2>&quot; &quot;</span> <span class=o>+</span> <span class=n>text</span>
</pre></div><p>If you want hook to respond to multiple commands, you can pass them as arguments to the hook.</p><div class=highlight><pre><span></span><span class=kn>from</span> <span class=nn>cloudbot</span> <span class=kn>import</span> <span class=n>hook</span>


<span class=nd>@hook.command</span><span class=p>(</span><span class=s2>&quot;echo&quot;</span><span class=p>,</span> <span class=s2>&quot;hello&quot;</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>echo</span><span class=p>(</span><span class=n>text</span><span class=p>):</span>
    <span class=k>return</span> <span class=n>text</span> <span class=o>+</span> <span class=s2>&quot; &quot;</span> <span class=o>+</span> <span class=n>text</span>
</pre></div><p>With this example, the hook will be triggered by <code>.echo</code> or <code>.hello</code></p><h3>Regex Hook</h3><p><code>@hook.regex(myregex)</code></p><p>Takes an argument corresponding to the regex string, or compiled regex, followed by optional flags. Each line of chat is matched against the provided regex pattern; if the bot finds a match, the hooked function will be called with the match object.</p><p>Here&#39;s an example that will match the regex <code>^Hi TestBot(!|\?|\.)?$</code>, and will return <code>Hi!</code> to the user saying it.</p><div class=highlight><pre><span></span><span class=kn>from</span> <span class=nn>cloudbot</span> <span class=kn>import</span> <span class=n>hook</span>


<span class=nd>@hook.regex</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;^Hi TestBot(!|\?|\.)?$&quot;</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>hi_hook</span><span class=p>(</span><span class=n>match</span><span class=p>):</span>
    <span class=k>return</span> <span class=s2>&quot;Hi!&quot;</span>
</pre></div><h3>IRC_RAW Hook</h3><p><code>@hook.irc_raw(myevent)</code></p><p>IRC_RAW hooks are called whenever a specific IRC command is issued. For example, to run some code whenever a user talks, you can use &#39;PRIVMSG&#39; as the argument. Using &#39;*&#39; as the argument will hook all IRC activity.</p><p>Some useful events to hook onto are:</p><ul><li>PRIVMSG - called when a user speaks</li><li>KICK - called when a user is kicked</li><li>NICK - called when a user changes nick</li><li>004 - called when the bot is connected to the network and ready to accept input</li></ul><p>The first argument returned for &#39;PRIVMSG&#39; be a two-element list of the form [&quot;#channel&quot;, &quot;text&quot;]. Details on what other types of event return will be added soon.</p><p>Here&#39;s an example IRC_RAW hook that will make the bot join two password-protected channels, when the bot starts up.</p><p>Note the &quot;conn&quot; argument to this hook. That&#39;s optional for hooks, and is just there so that conn.send can be run. We&#39;ll go into more detail into it, and other arguments below.</p><div class=highlight><pre><span></span><span class=kn>from</span> <span class=nn>cloudbot</span> <span class=kn>import</span> <span class=n>hook</span>


<span class=nd>@hook.irc_raw</span><span class=p>(</span><span class=err>“</span><span class=mo>004</span><span class=err>”</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>onready</span><span class=p>(</span><span class=n>paramlist</span><span class=p>,</span> <span class=n>conn</span><span class=p>):</span>
    <span class=n>conn</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&quot;JOIN #channel1 password1&quot;</span><span class=p>)</span>
    <span class=n>conn</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&quot;JOIN #channel2 password2&quot;</span><span class=p>)</span>
</pre></div><h3>Sieve Hook</h3><p><code>@hook.sieve()</code></p><p>All sieve hooks loaded are called whenever before other command, event or regex hook is called. Sieves can be used to control, or filter hooks.</p><p>Here&#39;s an example sieve which won&#39;t let any commands be used in the channel &#39;#channel1&#39;.</p><p>Note that any method using @hook.sieve, unlike other hooks, must take exactly 3 arguments.</p><p>The first argument is &#39;bot&#39;, the second is &#39;even&#39;, and the third is &#39;plugin&#39;.</p><p>If the sieve returns the same event that it was given, the plugin continues normally. If <code>None</code> is returned, then the plugin running is canceled, and the command/regex/event is not run.</p><div class=highlight><pre><span></span><span class=kn>from</span> <span class=nn>cloudbot</span> <span class=kn>import</span> <span class=n>hook</span>


<span class=nd>@hook.sieve</span><span class=p>()</span>
<span class=k>def</span> <span class=nf>mysieve</span><span class=p>(</span><span class=n>bot</span><span class=p>,</span> <span class=n>event</span><span class=p>,</span> <span class=n>plugin</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>plugin</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=s2>&quot;command&quot;</span><span class=p>:</span>  <span class=c1># if this is a command</span>
        <span class=k>if</span> <span class=n>event</span><span class=o>.</span><span class=n>chan</span> <span class=o>==</span> <span class=s2>&quot;#channel1&quot;</span><span class=p>:</span>  <span class=c1># if the channel is #channel1</span>
            <span class=k>return</span> <span class=bp>None</span>  <span class=c1># return None, canceling the action</span>

    <span class=k>return</span> <span class=n>event</span> <span class=c1># return event, so that the command will be run</span>
</pre></div><h3>Shared Arguments</h3><p>Part of the cool thing with CloudBot plugin hooks, is that what arguments your plugin is given, depends on the names of the arguments.</p><p>So if I define a command, <code>def mycommand(text)</code>, all it&#39;s given is the &#39;text&#39; argument.</p><p>If I define, <code>def mycommand(text, bot, chan)</code>, then it&#39;s given the &#39;text&#39; argument, the &#39;bot&#39; argument, and the &#39;chan&#39; argument.</p><p>This can be done for any hook, <strong>except sieve hooks</strong>. Sieve hook parameters are fixed, but all other hooks can have dynamic arguments like this.</p><p>Here are the different arguments you can ask for, and what they do:</p><table class=table><thead><tr><th>Name</th><th>Type</th><th>What it is</th><th>What hooks can use it</th></tr></thead><tbody><tr><td>text</td><td>String</td><td>Arguments to the command</td><td>command</td></tr><tr><td>match</td><td>Match</td><td>Regex match</td><td>regex</td></tr><tr><td>chan</td><td>String</td><td>Channel the command/regex is in</td><td>all</td></tr><tr><td>nick</td><td>String</td><td>Nick of the user using the command/regex</td><td>all</td></tr><tr><td>server</td><td>String</td><td>Server the command/regex is used on</td><td>all</td></tr><tr><td>db</td><td>SQLAlchemy database connection</td><td>Database connection, more info will be added later</td><td>all</td></tr><tr><td>event</td><td>Event</td><td>&quot;Event&quot; object, containing parameters as attributes</td><td>all</td></tr><tr><td>conn</td><td>BotConnection</td><td>Server-specific connection object</td><td>all</td></tr><tr><td>bot</td><td>CloudBot</td><td>Main bot object</td><td>all</td></tr></tbody></table><p>There are also a few functions which you can ask for, and get passed as parameters. They are like the above, but are actually functions, and can be called with name(parameters).</p><p>Here are some different methods you can use:</p><table class=table><thead><tr><th>Name</th><th>Usage</th><th>What it does</th></tr></thead><tbody><tr><td>message</td><td>message(&quot;hi&quot;)</td><td>Messages the channel</td></tr><tr><td>reply</td><td>reply(&quot;hi&quot;)</td><td>Sends a reply to the channel, prefixed with (Nick)</td></tr><tr><td>action</td><td>action(&quot;something&quot;)</td><td>Performs an action in the channel, like /me</td></tr><tr><td>ctcp</td><td>ctcp(&quot;msg&quot;, &quot;VERSION&quot;, nick)</td><td>Sends a CTCP message to the specified user</td></tr><tr><td>notice</td><td>notice(&quot;Incorrect args&quot;)</td><td>Notices a user</td></tr><tr><td>has_permission</td><td>has_permission(&quot;botcontrol&quot;)</td><td>Checks if the user has a specified permission (bot-specific)</td></tr></tbody></table><p>Here&#39;s an example command which uses the &#39;message&#39; function to raw message something.</p><div class=highlight><pre><span></span><span class=kn>from</span> <span class=nn>cloudbot</span> <span class=kn>import</span> <span class=n>hook</span>


<span class=nd>@hook.command</span><span class=p>()</span>
<span class=k>def</span> <span class=nf>mycmd</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
    <span class=n>message</span><span class=p>(</span><span class=s2>&quot;Hi people, someone said &#39;&quot;</span> <span class=o>+</span> <span class=n>text</span> <span class=o>+</span> <span class=s2>&quot;&#39;&quot;</span><span class=p>)</span>
</pre></div><h3>Permissions</h3><p>Sometimes you want to define a command, but don&#39;t want just anyone to have access to it.</p><p>You can specify a &#39;permission&#39; which anyone wanting to use your command will need, by adding a <code>permissions=[&quot;permissionname&quot;]</code> argument to your <code>@hook.command</code>. For example, <code>@hook.command(permissions=[&quot;botcontrol&quot;])</code>.</p><p>Example command requiring the &#39;botcontrol&#39; permission:</p><div class=highlight><pre><span></span><span class=kn>from</span> <span class=nn>cloudbot</span> <span class=kn>import</span> <span class=n>hook</span>


<span class=nd>@hook.command</span><span class=p>(</span><span class=n>permissions</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;botcontrol&quot;</span><span class=p>])</span>
<span class=k>def</span> <span class=nf>mycmd</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
    <span class=n>message</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</pre></div><p>This command just raw messages the input text. This isn&#39;t something you want to give to anyone though, so only people with access to botcontrol can use it.</p><p>Permissions are mainly controlled in the config, under each connection object. There are predefined groups, like &#39;admins&#39;, which have certain permissions. &#39;admins&#39; has access to botcontrol by default, so you can add yourself to it to gain access to this command.</p><p>There&#39;s also a utility command that you can use to add a user to a group, which can be accessed like so:</p><div class=highlight><pre><span></span>&lt;Myself&gt; TestBot, adduser Myself!~myself@my.host.example.com admins
</pre></div><p>This will add the mask <code>Myself!~myself@my.host.example.com</code> to the group <code>admins</code>.</p></div></div></div></div></div><script src=/assets/analytics.js?64b28601></script></body></html>